<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure Entra ID Consultant Tool</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Prompt', 'sans-serif'],
                        print: ['Sarabun', 'sans-serif'] 
                    },
                    colors: { msBlue: '#0078D4', msDark: '#004578', msGray: '#f3f2f1' }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Prompt', sans-serif; background-color: #f8fafc; color: #334155; }
        .check-item input:checked + span { text-decoration: line-through; color: #94a3b8; }
        [x-cloak] { display: none !important; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        /* --- PRINT STYLES --- */
        @media print {
            @page { size: A4; margin: 0; }
            body { background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; font-family: 'Sarabun', sans-serif; width: 100%; font-size: 10pt; color: #1e293b; }
            nav, .hero-section, main, .floating-btn, .modal-ui, .no-print { display: none !important; }
            #print-template { display: block !important; }
            .print-page { width: 210mm; min-height: 297mm; padding: 15mm 20mm; margin: 0 auto; background: white; position: relative; page-break-after: always; }
            .report-header { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 2px solid #0078D4; padding-bottom: 15px; margin-bottom: 25px; }
            .header-title h1 { font-size: 22pt; font-weight: bold; color: #004578; margin: 0; line-height: 1.1; }
            .score-section { display: flex; align-items: center; justify-content: space-between; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 25px; margin-bottom: 25px; page-break-inside: avoid; }
            .score-chart-wrapper { width: 140px; height: 140px; position: relative; flex-shrink: 0; display: flex; justify-content: center; align-items: center; }
            #printChart { width: 140px !important; height: 140px !important; }
            .rec-box { background: #eff6ff; border: 1px solid #bfdbfe; border-left: 5px solid #0078D4; padding: 15px 20px; border-radius: 6px; margin-bottom: 25px; page-break-inside: avoid; }
            .comparison-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 25px; }
            .list-box { border-top: 4px solid; padding-top: 10px; }
            .list-box.strength { border-color: #10b981; }
            .list-box.gaps { border-color: #ef4444; }
            .check-list li { padding: 6px 0; border-bottom: 1px dashed #e2e8f0; display: flex; align-items: flex-start; font-size: 9.5pt; line-height: 1.4; }
            .report-footer { position: absolute; bottom: 12mm; left: 0; right: 0; text-align: center; font-size: 8pt; color: #94a3b8; border-top: 1px solid #e2e8f0; padding-top: 8px; margin: 0 20mm; }
        }
        #print-template { display: none; }
    </style>
</head>
<body x-data="app()">

    <nav class="bg-white border-b border-slate-200 sticky top-0 z-40 no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-msBlue text-white p-1.5 rounded"><i class="fa-brands fa-microsoft text-xl"></i></div>
                <span class="font-bold text-lg text-slate-700">Entra ID <span class="text-msBlue">Consultant Tool</span></span>
            </div>
            <div class="text-sm text-slate-500">v4.2 Group Analyzer</div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 no-print">
        
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold flex items-center text-slate-800">
                    <i class="fa-solid fa-list-check text-msBlue mr-2"></i> Audit & Tools
                </h2>
                <a :href="currentTabInfo.link" target="_blank" class="text-xs text-msBlue hover:underline bg-blue-50 px-3 py-1 rounded-full border border-blue-100 transition-colors">
                    <i class="fa-solid fa-external-link-alt mr-1"></i> Open Resource
                </a>
            </div>
            
            <div class="flex overflow-x-auto gap-2 mb-6 pb-2 border-b custom-scroll">
                <template x-for="tab in tabs" :key="tab.id">
                    <button @click="activeTab = tab.id; highlightedItem = null;" 
                        :class="activeTab === tab.id ? 'bg-msBlue text-white shadow-md' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'" 
                        class="px-4 py-2.5 rounded-lg text-sm font-medium transition-all whitespace-nowrap flex items-center gap-2">
                        <i :class="tab.icon"></i> <span x-text="tab.label"></span>
                    </button>
                </template>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <template x-for="(item, index) in currentTabInfo.checklist" :key="index">
                        <div @click="highlightedItem = item" 
                             class="flex items-start gap-3 p-4 border rounded-xl cursor-pointer transition-all h-full"
                             :class="[
                                report.steps.includes(item.text) ? 'border-green-200 bg-green-50' : 'border-slate-200 hover:border-msBlue hover:shadow-sm',
                                highlightedItem === item ? 'ring-2 ring-msBlue ring-offset-1' : ''
                             ]">
                            <div class="pt-1" @click.stop>
                                <input type="checkbox" :value="item.text" x-model="report.steps" 
                                       class="w-5 h-5 text-msBlue rounded border-slate-300 focus:ring-msBlue cursor-pointer">
                            </div>
                            <div class="flex-1">
                                <span class="text-sm font-semibold text-slate-700 block" x-text="item.text"></span>
                                <span class="text-xs text-slate-500 block mt-1 leading-snug" x-text="item.why"></span>
                            </div>
                            <i class="fa-solid fa-chevron-right text-xs text-slate-400 mt-1"></i>
                        </div>
                    </template>
                </div>

                <div class="lg:col-span-1 bg-slate-50 border border-slate-200 rounded-xl p-5 sticky top-24 h-fit">
                    <div x-show="!highlightedItem" class="text-center py-10 text-slate-400">
                        <i class="fa-solid fa-laptop-code text-4xl mb-3 opacity-50"></i>
                        <p class="text-sm">Select an item to view<br>details & usage guide.</p>
                    </div>

                    <div x-show="highlightedItem" x-transition.opacity>
                        <h3 class="font-bold text-lg text-slate-800 mb-4 border-b pb-2" x-text="highlightedItem?.text"></h3>
                        
                        <div class="space-y-4">
                            <div>
                                <div class="text-xs font-bold text-blue-600 uppercase mb-1"><i class="fa-solid fa-info-circle mr-1"></i> Description</div>
                                <p class="text-sm text-slate-600 leading-relaxed bg-white p-3 rounded border border-blue-100" x-text="highlightedItem?.guide"></p>
                            </div>

                            <div>
                                <div class="text-xs font-bold text-green-600 uppercase mb-1"><i class="fa-solid fa-terminal mr-1"></i> Usage / Steps</div>
                                <ol class="list-decimal pl-4 text-sm text-slate-600 space-y-1 bg-white p-3 rounded border border-slate-200">
                                    <template x-for="step in highlightedItem?.steps">
                                        <li class="pl-1 leading-snug"><span x-text="step"></span></li>
                                    </template>
                                </ol>
                            </div>
                            
                            <div x-show="activeTab === 'tools'" class="mt-4">
                                <a :href="currentTabInfo.link" target="_blank" class="block w-full text-center py-2 bg-slate-800 text-white rounded-lg text-sm hover:bg-slate-900 transition-colors">
                                    <i class="fa-brands fa-github mr-2"></i> View on GitHub
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex justify-end gap-4 sticky bottom-6">
            <button @click="reset()" class="px-6 py-3 bg-white border border-red-200 text-red-500 rounded-xl hover:bg-red-50 font-medium shadow-sm transition-transform hover:scale-105">
                <i class="fa-solid fa-trash-can mr-2"></i> Reset
            </button>
            <button @click="openModal()" class="px-8 py-3 bg-msBlue text-white rounded-xl font-bold hover:bg-msDark shadow-lg shadow-blue-500/30 flex items-center gap-2 transform transition hover:scale-105">
                <i class="fa-solid fa-file-contract"></i> Generate Report
            </button>
        </div>
    </main>

    <div x-show="showModal" class="fixed inset-0 z-50 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4 modal-ui" x-cloak x-transition.opacity>
        <div class="bg-white w-full max-w-5xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[95vh]">
            <div class="bg-white px-8 py-5 border-b flex justify-between items-center">
                <h2 class="text-2xl font-bold text-slate-800">Report Generator</h2>
                <button @click="showModal = false" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-8 overflow-y-auto flex-1 bg-slate-50">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-6">
                        <div class="bg-white p-5 rounded-xl border shadow-sm">
                            <h3 class="font-bold text-slate-700 mb-3 border-b pb-2">1. General Info</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-xs font-bold text-slate-500 uppercase">Ticket ID</label><input type="text" x-model="report.ticketId" class="w-full border rounded p-2 text-sm mt-1"></div>
                                <div><label class="text-xs font-bold text-slate-500 uppercase">Engineer</label><input type="text" x-model="report.engineer" class="w-full border rounded p-2 text-sm mt-1"></div>
                            </div>
                        </div>
                        <div class="bg-white p-5 rounded-xl border shadow-sm">
                            <h3 class="font-bold text-slate-700 mb-3 border-b pb-2">2. Recommendation</h3>
                            <textarea x-model="report.recommendations" class="w-full h-24 p-3 border rounded text-sm bg-blue-50/50 resize-none"></textarea>
                        </div>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-white p-5 rounded-xl border shadow-sm">
                            <h3 class="font-bold text-slate-700 mb-3 border-b pb-2">3. Critical Gaps</h3>
                            <textarea x-model="report.painPoints" class="w-full h-24 p-3 border border-red-200 bg-red-50/30 rounded text-sm resize-none"></textarea>
                        </div>
                        <div class="bg-white p-5 rounded-xl border shadow-sm">
                            <h3 class="font-bold text-slate-700 mb-3 border-b pb-2">4. Roadmap</h3>
                            <textarea x-model="report.projectPlan" class="w-full h-32 p-3 border border-green-200 bg-green-50/30 rounded text-sm font-mono resize-none"></textarea>
                            <button @click="addPlan()" class="text-xs text-green-600 underline mt-1">Auto-Generate Plan</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-5 border-t bg-white flex justify-end gap-3">
                <button @click="showModal = false" class="px-6 py-2 rounded text-slate-500 hover:bg-slate-50">Cancel</button>
                <button @click="printReport()" class="px-8 py-2 bg-msBlue text-white rounded-lg font-bold hover:bg-msDark shadow-lg flex items-center gap-2">
                    <i class="fa-solid fa-print"></i> Print Report
                </button>
            </div>
        </div>
    </div>

    <div id="print-template">
        <div class="print-page">
            <div class="report-header">
                <div class="header-title"><h1>Security Assessment Report</h1><p>Microsoft Entra ID Architecture Review</p></div>
                <div class="header-meta"><p><strong>Date:</strong> <span x-text="new Date().toLocaleDateString('th-TH')"></span></p><p><strong>Ref:</strong> <span x-text="report.ticketId || '-'"></span></p></div>
            </div>
            <div class="score-section">
                <div class="score-text">
                    <h3 class="text-lg font-bold text-slate-800">1. Security Score</h3>
                    <p class="text-sm text-slate-500">Based on Microsoft Entra best practices.</p>
                    <div class="flex gap-6 mt-2">
                        <div><div class="text-2xl font-bold text-slate-700" x-text="report.steps.length"></div><div class="text-[10px] uppercase text-slate-400 font-bold">Passed</div></div>
                        <div><div class="text-2xl font-bold text-danger" x-text="totalItems - report.steps.length"></div><div class="text-[10px] uppercase text-slate-400 font-bold">Gaps</div></div>
                    </div>
                </div>
                <div class="score-chart-wrapper"><canvas id="printChart" width="140" height="140"></canvas><div class="score-value" x-text="Math.round((report.steps.length / totalItems) * 100) + '%'"></div></div>
            </div>
            <div class="section-title text-msBlue mb-2 font-bold"><i class="fa-solid fa-star"></i> 2. Recommended Solution</div>
            <div class="rec-box"><div style="white-space: pre-wrap; font-weight: 500;" x-text="report.recommendations"></div></div>
            <div class="comparison-grid">
                <div><div class="section-title text-success font-bold mb-2"><i class="fa-solid fa-check-circle"></i> 3. Current Strength</div><div class="list-box strength"><ul class="check-list"><template x-for="step in report.steps"><li><i class="fa-solid fa-check text-success"></i> <span x-text="step"></span></li></template></ul></div></div>
                <div><div class="section-title text-danger font-bold mb-2"><i class="fa-solid fa-triangle-exclamation"></i> 4. Critical Gaps</div><div class="list-box gaps"><ul class="check-list"><template x-for="line in report.painPoints.split('\n')"><li x-show="line.trim()"><i class="fa-solid fa-xmark text-danger"></i> <span x-text="line"></span></li></template></ul></div></div>
            </div>
            <div class="section-title text-slate-700 font-bold mb-2">5. Roadmap</div>
            <div class="roadmap-box" x-text="report.projectPlan"></div>
            <div class="report-footer">Confidential Security Assessment • Generated by Entra ID Expert Tool • &copy; 2026 Mr.Abdulloh Etae-ngoh</div>
        </div>
    </div>

    <script>
        function app() {
            return {
                showModal: false, activeTab: 'tools', highlightedItem: null,
                report: { ticketId: '', engineer: '', steps: [], painPoints: '', recommendations: '', projectPlan: '' },
                
                tabs: [
                    { id: 'tools', label: 'Tools & Scripts', icon: 'fa-solid fa-toolbox' },
                    { id: 'arch', label: 'Architecture', icon: 'fa-solid fa-shield-halved' },
                    { id: 'human', label: 'Human Identity', icon: 'fa-solid fa-user-shield' },
                    { id: 'ops', label: 'Governance', icon: 'fa-solid fa-file-contract' }
                ],
                
                content: {
                    tools: {
                        label: 'Group & Policy Analysis Tools',
                        link: 'https://github.com/jasperbaes/Microsoft-Cloud-Group-Analyzer',
                        checklist: [
                            { 
                                text: 'Microsoft Cloud Group Analyzer', 
                                why: 'Visualize group dependencies across all services.', 
                                guide: 'A Node.js script that scans your tenant to find where Entra ID groups are used (CA Policies, Intune, Enterprise Apps, Roles). Helps prevent outages before deleting groups.',
                                steps: [
                                    'Pre-req: Install Node.js on your machine.',
                                    'Clone Repo: git clone https://github.com/jasperbaes/Microsoft-Cloud-Group-Analyzer',
                                    'Create App Registration in Entra ID (Read Permissions).',
                                    'Run: npm install && npm start',
                                    'View "webreport" output to see group usage map.'
                                ]
                            },
                            {
                                text: 'Entra Exporter (PowerShell)',
                                why: 'Backup configuration as code.',
                                guide: 'Export all Entra ID settings to JSON for backup or documentation.',
                                steps: ['Install-Module EntraExporter', 'Connect-Entra', 'Export-Entra -Path ./Backup']
                            }
                        ]
                    },
                    arch: {
                        label: 'Isolation & Principles',
                        link: 'https://learn.microsoft.com/en-us/entra/architecture/secure-best-practices',
                        checklist: [
                            { text: 'Use Modern Auth (SAML/OIDC)', why: 'Legacy is insecure.', guide: 'Apps must use OAuth2/OIDC.', steps: ['Inventory legacy apps.', 'Disable Legacy Auth in CA.'] },
                            { text: 'Deploy Secure Workstations (SAW)', why: 'Protect admins.', guide: 'Admins use hardened devices.', steps: ['Provision dedicated admin PC.'] }
                        ]
                    },
                    human: {
                        label: 'Human Identity Management',
                        link: 'https://learn.microsoft.com/en-us/entra/architecture/secure-best-practices',
                        checklist: [
                            { text: 'No Standing Access (PIM)', why: 'Zero Trust.', guide: 'JIT access for admins.', steps: ['Configure PIM.', 'Remove permanent roles.'] },
                            { text: 'Phishing-Resistant MFA', why: 'Anti-AiTM.', guide: 'FIDO2 for Admins.', steps: ['Enable FIDO2 keys.', 'Enforce via CA.'] }
                        ]
                    },
                    ops: {
                        label: 'Governance & Operations',
                        link: 'https://learn.microsoft.com/en-us/entra/architecture/secure-best-practices',
                        checklist: [
                            { text: 'Break Glass Accounts', why: 'Emergency access.', guide: '2 Cloud-only GAs.', steps: ['Create user.', 'Exclude from CA.', 'Monitor sign-ins.'] },
                            { text: 'Analyze Group Usage', why: 'Prevent impact.', guide: 'Use Group Analyzer tool.', steps: ['Run Group Analyzer script.', 'Check dependencies before delete.'] }
                        ]
                    }
                },
                
                get currentTabInfo() { return this.content[this.activeTab]; },
                get totalItems() { return Object.values(this.content).reduce((acc, c) => acc + c.checklist.length, 0); },

                openModal() { this.showModal = true; },
                reset() { if(confirm('Reset?')) this.report = { ticketId: '', engineer: '', steps: [], painPoints: '', recommendations: '', projectPlan: '' }; },
                addPlan() { this.report.projectPlan = "Phase 1: Analysis (Week 1)\n- Run Group Analyzer Tool\n- Inventory Legacy Apps\n\nPhase 2: Hardening (Month 1)\n- Deploy PIM for Roles\n- Enforce FIDO2 for Admins\n\nPhase 3: Cleanup (Month 2)\n- Remove unused groups based on analysis"; },

                printReport() {
                    setTimeout(() => {
                        const score = Math.round((this.report.steps.length / this.totalItems) * 100);
                        const ctx = document.getElementById('printChart');
                        if (window.myPrintChart) window.myPrintChart.destroy();
                        window.myPrintChart = new Chart(ctx, {
                            type: 'doughnut',
                            data: { datasets: [{ data: [score, 100-score], backgroundColor: ['#0078D4', '#e2e8f0'], borderWidth: 0 }] },
                            options: { responsive: false, cutout: '75%', animation: false, plugins: { tooltip: { enabled: false } } }
                        });
                        window.print();
                    }, 500);
                }
            }
        }
    </script>
</body>
</html>